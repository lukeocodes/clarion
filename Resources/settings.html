<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clarion Settings</title>
<link rel="stylesheet" href="styles.css">
</head>
<body class="page-top">
  <div class="container fade-in stack-6">
    <h1 class="text-lg font-semibold">Settings</h1>

    <!-- API Key Section -->
    <section class="stack-3">
      <h2 class="section-heading">API Key</h2>
      <div class="input-wrapper">
        <input id="apiKey" name="apiKey" autocomplete="off" type="password"
               placeholder="dg-xxxxxxxxxxxx" class="input input-with-toggle">
        <button onclick="toggleKeyVisibility()" id="btnToggle" class="input-toggle" title="Show/hide key">
          <svg id="iconEye" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          <svg id="iconEyeSlash" class="hidden" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88"/>
          </svg>
        </button>
      </div>

      <div class="flex-row gap-3">
        <button onclick="saveKey()" id="btnSave" class="btn btn-primary flex-1" disabled>Save Key</button>
        <button onclick="clearKey()" id="btnClear" class="btn btn-danger">Clear Key</button>
      </div>
    </section>

    <!-- Voice Section -->
    <section class="stack-3">
      <h2 class="section-heading">Voice</h2>
      <div>
        <label for="voiceModel">Voice Model</label>
        <select id="voiceModel" onchange="voiceChanged()" class="input">
          <option value="aura-2-thalia-en">Thalia</option>
          <option value="aura-2-andromeda-en">Andromeda</option>
          <option value="aura-2-arcas-en">Arcas</option>
          <option value="aura-2-athena-en">Athena</option>
          <option value="aura-2-hermes-en">Hermes</option>
          <option value="aura-2-luna-en">Luna</option>
          <option value="aura-2-orpheus-en">Orpheus</option>
          <option value="aura-2-orion-en">Orion</option>
          <option value="aura-2-asteria-en">Asteria</option>
          <option value="aura-2-zeus-en">Zeus</option>
        </select>
      </div>

      <div class="flex-row gap-3">
        <button onclick="testVoice()" id="btnTestVoice" class="btn btn-secondary">Test Voice</button>
        <span id="voiceStatus" class="text-sm"></span>
      </div>

      <!-- Audio player -->
      <div id="playerWrap" class="hidden">
        <div class="player">
          <button onclick="togglePlayback()" id="btnPlay" class="player-btn" title="Play/Pause">
            <svg id="iconPlay" class="player-icon" fill="currentColor" viewBox="0 0 20 20">
              <path d="M6.3 2.84A1.5 1.5 0 004 4.11v11.78a1.5 1.5 0 002.3 1.27l9.344-5.891a1.5 1.5 0 000-2.538L6.3 2.84z"/>
            </svg>
            <svg id="iconPause" class="player-icon hidden" fill="currentColor" viewBox="0 0 20 20">
              <path d="M5.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75A.75.75 0 007.25 3h-1.5zM12.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75a.75.75 0 00-.75-.75h-1.5z"/>
            </svg>
          </button>
          <div class="player-track" id="playerTrack" onclick="seek(event)">
            <div class="player-progress" id="playerProgress"></div>
          </div>
          <span class="player-time text-xs text-muted" id="playerTime">0:00</span>
        </div>
      </div>
    </section>

    <!-- Key status -->
    <div id="keyStatus" class="status text-center"></div>
  </div>

  <!-- Clear confirmation modal -->
  <div id="clearModal" class="modal-overlay">
    <div class="modal">
      <h3 class="font-semibold">Clear API Key?</h3>
      <p>This will remove your stored Deepgram API key.</p>
      <div class="flex-row gap-3 justify-end">
        <button onclick="dismissClearModal()" class="btn btn-secondary">Cancel</button>
        <button onclick="confirmClear()" class="btn btn-danger-fill">Clear</button>
      </div>
    </div>
  </div>

<script>
const keyInput = document.getElementById('apiKey');
const btnSave = document.getElementById('btnSave');
const keyStatus = document.getElementById('keyStatus');
const voiceStatus = document.getElementById('voiceStatus');
const voiceSelect = document.getElementById('voiceModel');
let keyVisible = false;

keyInput.addEventListener('input', () => {
  btnSave.disabled = keyInput.value.trim().length === 0;
});

function postAction(action, data = {}) {
  window.webkit.messageHandlers.clarion.postMessage({ action, ...data });
}

function toggleKeyVisibility() {
  keyVisible = !keyVisible;
  keyInput.type = keyVisible ? 'text' : 'password';
  document.getElementById('iconEye').classList.toggle('hidden', keyVisible);
  document.getElementById('iconEyeSlash').classList.toggle('hidden', !keyVisible);
}

function saveKey() {
  const apiKey = keyInput.value.trim();
  if (!apiKey) return;
  postAction('saveKey', { apiKey });
}

function clearKey() {
  document.getElementById('clearModal').classList.add('visible');
}

function dismissClearModal() {
  document.getElementById('clearModal').classList.remove('visible');
}

function confirmClear() {
  dismissClearModal();
  postAction('clearKey');
}

function voiceChanged() {
  postAction('setVoiceModel', { model: voiceSelect.value });
}

// Audio player state
let audio = null;
let animFrame = null;

function testVoice() {
  const apiKey = keyInput.value.trim();
  // Stop any current playback
  if (audio) { audio.pause(); audio = null; }
  postAction('testVoice', { apiKey, model: voiceSelect.value });
}

function loadAudio(base64) {
  if (audio) { audio.pause(); }
  if (animFrame) { cancelAnimationFrame(animFrame); }

  audio = new Audio('data:audio/wav;base64,' + base64);
  audio.addEventListener('ended', () => { updatePlayerUI(false); });
  audio.addEventListener('timeupdate', updateProgress);

  document.getElementById('playerWrap').classList.remove('hidden');
  audio.play();
  updatePlayerUI(true);
}

function togglePlayback() {
  if (!audio) return;
  if (audio.paused) { audio.play(); updatePlayerUI(true); }
  else { audio.pause(); updatePlayerUI(false); }
}

function updatePlayerUI(playing) {
  document.getElementById('iconPlay').classList.toggle('hidden', playing);
  document.getElementById('iconPause').classList.toggle('hidden', !playing);
}

function updateProgress() {
  if (!audio || !audio.duration) return;
  const pct = (audio.currentTime / audio.duration) * 100;
  document.getElementById('playerProgress').style.width = pct + '%';
  const remaining = audio.duration - audio.currentTime;
  const m = Math.floor(remaining / 60);
  const s = Math.floor(remaining % 60).toString().padStart(2, '0');
  document.getElementById('playerTime').textContent = m + ':' + s;
}

function seek(e) {
  if (!audio || !audio.duration) return;
  const track = document.getElementById('playerTrack');
  const rect = track.getBoundingClientRect();
  const pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
  audio.currentTime = pct * audio.duration;
}

function updateState(state) {
  if (state.apiKey !== undefined) {
    keyInput.value = state.apiKey;
    btnSave.disabled = state.apiKey.length === 0;
  }
  if (state.voiceModel) {
    voiceSelect.value = state.voiceModel;
  }
  if (state.keySaved === true) {
    keyStatus.innerHTML = '<span class="text-success">✓ Key saved</span>';
    setTimeout(() => { keyStatus.innerHTML = ''; }, 2000);
  } else if (state.keySaved === false) {
    keyStatus.innerHTML = '<span class="text-error">✗ Failed to save key</span>';
  }
  if (state.keyCleared) {
    keyInput.value = '';
    btnSave.disabled = true;
    keyStatus.innerHTML = '<span class="text-muted">Key cleared</span>';
    setTimeout(() => { keyStatus.innerHTML = ''; }, 2000);
  }
  // Voice test results
  if (state.voiceTest === 'testing') {
    voiceStatus.innerHTML = '<span class="text-muted">Testing…</span>';
    document.getElementById('btnTestVoice').disabled = true;
  } else if (state.voiceTest === 'success') {
    voiceStatus.innerHTML = '';
    document.getElementById('btnTestVoice').disabled = false;
    if (state.audioData) { loadAudio(state.audioData); }
  } else if (state.voiceTest === 'failure') {
    voiceStatus.innerHTML = '<span class="text-error">✗ Test failed</span>';
    document.getElementById('btnTestVoice').disabled = false;
  } else if (state.voiceTest === 'idle') {
    voiceStatus.innerHTML = '';
    document.getElementById('btnTestVoice').disabled = false;
  }
}
</script>
</body>
</html>
