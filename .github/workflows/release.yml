name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json

  build:
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Stamp version in Info.plist
        run: |
          VERSION="${{ needs.release-please.outputs.version }}"
          # CFBundleShortVersionString ← release version (e.g. 0.2.0)
          sed -i '' "/<key>CFBundleShortVersionString<\/key>/{n;s|<string>.*</string>|<string>${VERSION}</string>|;}" Resources/Info.plist
          # CFBundleVersion ← run number for monotonic build ID
          sed -i '' "/<key>CFBundleVersion<\/key>/{n;s|<string>.*</string>|<string>${{ github.run_number }}</string>|;}" Resources/Info.plist

      - name: Build
        run: swift build -c release

      - name: Create app bundle
        run: make bundle

      - name: Create DMG
        run: |
          hdiutil create \
            -volname Clarion \
            -srcfolder .build/Clarion.app \
            -ov \
            -format UDZO \
            Clarion-${{ needs.release-please.outputs.tag_name }}.dmg

      - name: Upload DMG to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: Clarion-${{ needs.release-please.outputs.tag_name }}.dmg
